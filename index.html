<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Jur√≠dico Completo</title>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/727/727399.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css" rel="stylesheet">
    <style>
        :root {
            --cor-vinho: #5D1A2A;
            --cor-dourado: #D4AF37;
            --cor-dourado-hover: #c09b2d;
            --cor-bege-claro: #F3EAD3;
            --cor-bege-fundo: #EFEBE0;
            --cor-texto-escuro: #3d2c21;
            --main: var(--cor-vinho);
            --accent: var(--cor-dourado);
            --accent-light: var(--cor-bege-claro);
            --danger: #ff6b6b;
            --success: #4caf50;
            --info: #42a5f5;
            --warning: #ffb74d;
            --bg: var(--cor-bege-fundo);
            --white: #ffffff;
            --border: #ddd3bb;
            --dark-text: var(--cor-texto-escuro);
            --muted-text: #8c7a6b;
            --radius: 1rem;
            --shadow: 0 4px 18px rgba(0, 0, 0, .08);
            --transition: .2s ease-in-out;

            /* Fluid type scale */
            --fs-base: clamp(0.9rem, 0.25vw + 0.9rem, 1rem);
            --fs-h1: clamp(1.4rem, 1.5vw + 1rem, 2.2rem);
            --fs-h2: clamp(1.25rem, 1.2vw + 0.8rem, 1.8rem);
            --fs-h3: clamp(1.1rem, 1vw + 0.6rem, 1.5rem);
            --fs-value: clamp(1.8rem, 2vw + 1rem, 2.2rem);

            font-family: 'Inter', system-ui, sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: var(--bg);
            color: var(--dark-text);
            font-size: var(--fs-base);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        p {
            font-size: var(--fs-base);
        }

        header {
            background: var(--main);
            color: var(--white);
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            padding: 1rem 2rem;
            box-shadow: var(--shadow);
            gap: 1.5rem;
        }

        header h1 {
            font-size: var(--fs-h1);
            font-weight: 700;
            color: var(--cor-bege-claro);
            flex-shrink: 0;
        }

        nav {
            flex-grow: 1;
            display: flex;
            gap: .5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        nav button {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(243, 234, 211, 0.3);
            color: var(--cor-bege-claro);
            padding: .6rem 1.2rem;
            font-size: 0.95rem;
            font-weight: 600;
            border-radius: .7rem;
            cursor: pointer;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        nav button:hover {
            background: var(--cor-dourado);
            border-color: var(--cor-dourado-hover);
            color: var(--cor-texto-escuro);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        nav button.active {
            background: var(--cor-dourado);
            border-color: var(--cor-dourado);
            color: var(--cor-texto-escuro);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        nav button:active {
            transform: scale(0.97);
            transition: transform .1s ease;
        }

        header>button.btn {
            margin-left: auto;
            flex-shrink: 0;
        }

        .btn {
            background: var(--accent);
            color: var(--cor-texto-escuro);
            border: none;
            padding: .75rem 1.5rem;
            font-size: .95rem;
            font-weight: 600;
            border-radius: .7rem;
            cursor: pointer;
            transition: all var(--transition);
            box-shadow: 0 2px 6px rgba(0, 0, 0, .1);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn:hover {
            background: var(--cor-dourado-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, .3);
        }

        .btn-success {
            background: var(--success);
            color: var(--white);
        }

        .btn-success:hover {
            background: #059669;
            box-shadow: 0 4px 12px rgba(16, 185, 129, .4);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }

        .btn-danger:hover {
            background: #dc2626;
            box-shadow: 0 4px 12px rgba(239, 68, 68, .4);
        }

        .btn-info {
            background: var(--info);
            color: var(--white);
        }

        .btn-info:hover {
            background: #0284c7;
            box-shadow: 0 4px 12px rgba(14, 165, 233, .4);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2.5rem 2rem;
        }

        .tab-content {
            display: none;
            animation: fadeIn .4s;
        }

        .tab-content.active {
            display: block;
        }

        .section-header {
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .section-header h2 {
            font-size: var(--fs-h2);
        }

        .filter-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
            align-items: center;
        }

        .filter-bar input,
        .filter-bar select {
            flex-grow: 1;
            min-width: 200px;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: .9rem 1rem;
            font-size: .98rem;
            border: 1.5px solid var(--border);
            border-radius: .65rem;
            background: var(--cor-bege-claro);
            transition: all var(--transition);
            font-family: 'Inter', sans-serif;
            color: var(--cor-texto-escuro);
        }

        input:focus,
        textarea:focus,
        select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px #c09b2d55;
            outline: none;
        }

        .form-group {
            margin-bottom: 1.2rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: .5rem;
            font-size: .9rem;
        }

        #login-panel {
            max-width: 400px;
            margin: 10vh auto;
            background: var(--cor-bege-claro);
            border-radius: var(--radius);
            padding: 6vw;
            box-shadow: var(--shadow);
            text-align: center;
        }

        #login-panel h2 {
            font-size: var(--fs-h2);
            font-weight: 700;
            margin-bottom: 2rem;
            color: var(--main);
        }

        #login-erro {
            color: var(--danger);
            margin-top: 1rem;
            font-size: .9rem;
            display: none;
        }

        #painel-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }

        @media (max-width: 768px) {
            #painel-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            .dashboard-grid {
                grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            }
        }

        #resumo-financeiro.painel-cards {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 2rem;
        }

        #resumo-financeiro.painel-cards .card {
            flex: 0 1 260px;
            min-width: 220px;
        }

        .card {
            background: var(--cor-bege-claro);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: .5rem;
            transition: all var(--transition);
            border: 1px solid #ddd3bb;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, .1);
            border-color: var(--accent);
        }

        .card .icon {
            font-size: 1.8rem;
            color: var(--main);
        }

        .card .value {
            font-size: var(--fs-value);
            font-weight: 800;
        }

        .card .label {
            color: var(--muted-text);
            font-weight: 500;
        }


        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            .chart-box canvas {
                width: 100% !important;
                height: auto !important;
            }
        }

        .chart-box {
            background: var(--cor-bege-claro);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }

        .chart-box h3 {
            margin: 0 0 1rem 0;
            text-align: center;
            font-size: var(--fs-h3);
        }

        #painel-prazos ul {
            list-style: none;
            padding: 1rem 0;
        }

        #painel-prazos li {
            background: var(--accent-light);
            padding: .8rem 1.2rem;
            border-radius: .8rem;
            margin-bottom: .5rem;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border);
        }

        .table-wrapper {
            overflow-x: auto;
            background: var(--cor-bege-claro);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 1rem 1.2rem;
            text-align: left;
            font-size: .95rem;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: transparent;
            color: var(--muted-text);
            font-weight: 600;
            text-transform: uppercase;
            font-size: .8rem;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover td {
            background: var(--cor-bege-fundo);
        }

        td .actions {
            display: flex;
            gap: .5rem;
        }

        td .actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            color: var(--muted-text);
            padding: .3rem;
            transition: color var(--transition);
        }

        td .actions button:hover {
            color: var(--accent);
        }

        .badge {
            display: inline-block;
            padding: .2rem .6rem;
            border-radius: 99px;
            font-size: .75rem;
            font-weight: 600;
            color: var(--cor-texto-escuro);
            text-align: center;
        }

        .badge.Ativo,
        .badge.Agendado {
            background: var(--accent);
        }

        .badge.Conclu√≠do,
        .badge.Conclu√≠da,
        .badge.Realizado,
        .badge.Pago {
            background: var(--success);
            color: var(--white);
        }

        .badge.Arquivado,
        .badge.Cancelado {
            background: var(--muted-text);
            color: var(--white);
        }

        .badge.Pendente,
        .badge.Vencido {
            background: var(--warning);
        }

        .badge.Alta {
            background: var(--danger);
            color: var(--white);
        }

        .badge.M√©dia {
            background: var(--warning);
        }

        .badge.Baixa {
            background: var(--info);
            color: var(--white);
        }

        .badge.Receber {
            background: var(--success);
            color: var(--white);
        }

        .badge.Pagar {
            background: var(--danger);
            color: var(--white);
        }

        .modal-bg {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(61, 44, 33, .5);
            backdrop-filter: blur(4px);
            z-index: 999;
            animation: fadeIn .3s;
        }

        .modal-bg.active {
            display: flex;
        }

        .modal {
            background: var(--cor-bege-fundo);
            border-radius: var(--radius);
            padding: 6vw;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .1);
            animation: scaleIn .3s;
            border: 1px solid var(--border);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h3 {
            font-size: var(--fs-h3);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.8rem;
            color: var(--muted-text);
            cursor: pointer;
            line-height: 1;
        }

        .modal-footer {
            margin-top: 2rem;
            text-align: right;
        }

        #notificacoes {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            width: min(320px, calc(100% - 2rem));
        }

        .notif {
            background: var(--cor-bege-claro);
            border-left: 5px solid var(--accent);
            padding: 1rem 1.5rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            border-radius: .8rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, .1);
            margin-bottom: 1rem;
            animation: slideIn .4s forwards;
            transform: translateX(120%);
            color: var(--cor-texto-escuro);
        }

        .notif.success {
            border-left-color: var(--success);
        }

        .notif.danger {
            border-left-color: var(--danger);
        }

        .notif i {
            font-size: 1.4rem;
            opacity: .8;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes slideIn {
            to {
                transform: translateX(0);
            }
        }

        .cliente-card {
            background: var(--cor-bege-claro);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
        }

        .cliente-card h3 {
            font-size: var(--fs-h3);
            color: var(--main);
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--cor-dourado);
            padding-bottom: .5rem;
        }

        #casos-por-cliente-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .cliente-card ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .cliente-card li {
            padding: .5rem 0;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .cliente-card li:last-child {
            border-bottom: none;
        }

        .cliente-card li .badge {
            margin-left: .5rem;
        }



        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 4rem auto;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }

        .calendar-container {
            background: var(--cor-bege-claro);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }

        /* Estilos para o FullCalendar */
        .fc .fc-button {
            background-color: var(--accent);
            border-color: var(--accent);
            color: var(--cor-texto-escuro);
            text-transform: capitalize;
            /* Garante que o texto dos bot√µes seja capitalizado */
        }

        .fc .fc-button:hover {
            background-color: var(--cor-dourado-hover);
            border-color: var(--cor-dourado-hover);
        }

        .fc .fc-button-primary:not(:disabled).fc-button-active {
            background-color: var(--main);
            border-color: var(--main);
            color: var(--white);
            /* Cor do texto para o bot√£o ativo */
        }

        .fc .fc-toolbar-title {
            color: var(--dark-text);
            font-size: var(--fs-h2);
            font-weight: 700;
        }

        .fc .fc-col-header-cell-cushion {
            color: var(--main);
            font-weight: 600;
            padding: .5rem 0;
            /* Espa√ßamento para os dias da semana */
        }

        .fc .fc-daygrid-day-number {
            color: var(--dark-text);
            font-weight: 500;
            padding: .2rem .4rem;
        }

        .fc .fc-daygrid-day.fc-day-today {
            background-color: var(--accent-light);
            /* Cor de fundo para o dia atual */
            border-radius: .5rem;
        }

        .fc .fc-event {
            background-color: var(--main);
            border-color: var(--main);
            border-radius: .3rem;
            padding: .2rem .4rem;
            margin-bottom: 3px;
            /* Aumenta um pouco o espa√ßamento entre eventos empilhados */
            font-size: .85rem;
            color: var(--white);
            cursor: pointer;
            overflow: visible;
            white-space: normal;
            line-height: 1.2;
        }

        .fc .fc-event-title {
            color: var(--white);
            font-size: .85rem;
            white-space: normal;
            overflow-wrap: anywhere;
        }

        .fc-event-time {
            font-weight: 600;
            white-space: normal;
        }

        .fc-daygrid-event-dot {
            border-color: var(--white);
        }

        .fc-event-details {
            margin-top: .2rem;
            font-size: .7rem;
            display: flex;
            flex-wrap: wrap;
            gap: .2rem;
        }

        .fc .fc-event.status-agendado {
            background-color: var(--accent);
            border-color: var(--accent);
        }

        .fc .fc-event.status-realizado {
            background-color: var(--success);
            border-color: var(--success);
        }

        .fc .fc-event.status-cancelado {
            background-color: var(--danger);
            border-color: var(--danger);
        }

        .fc .fc-event.status-pendente {
            background-color: var(--warning);
            border-color: var(--warning);
        }

        .fc .fc-event.prioridade-alta {
            background-color: var(--danger);
            border-color: var(--danger);
        }

        .fc .fc-event.prioridade-media {
            background-color: var(--warning);
            border-color: var(--warning);
        }

        .fc .fc-event.prioridade-baixa {
            background-color: var(--info);
            border-color: var(--info);
        }

        .calendar-container {
            display: block;
        }

        /* Responsividade para o calend√°rio */
        @media (max-width: 768px) {
            .fc-toolbar {
                flex-direction: column;
            }

            .fc .fc-toolbar-title {
                margin-bottom: 0.5rem;
            }

            .fc .fc-button-group {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
            }

            .fc .fc-button {
                margin: .2rem;
                padding: .4rem .8rem;
            }

            .fc .fc-event {
                padding: .1rem .3rem;
            }

            .fc-list-event .fc-event-main-frame {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .fc-list-event .fc-event-details {
                margin-top: 0.5rem;
            }

            .calendar-container {
                display: block;
                margin-top: 1rem;
            }

        }

        /* Otimiza√ß√£o do layout do dashboard-grid */
        .dashboard-grid {
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            /* Ajuste para telas menores */
        }

        @media(max-width: 800px) {

            .filter-bar,
            .section-header {
                flex-direction: column;
                padding: 1rem;
                align-items: stretch;
            }

            .container {
                padding: 1.5rem 1rem;
            }

            .modal {
                padding: 3vw;
            }

            .table-wrapper {
                box-shadow: none;
            }

            table {
                box-shadow: var(--shadow);
            }

            thead {
                display: none;
            }

            tr {
                display: block;
                margin-bottom: 1rem;
                border-radius: .8rem;
                overflow: hidden;
                box-shadow: var(--shadow);
                background: var(--cor-bege-claro);
            }

            td {
                display: block;
                text-align: right;
                position: relative;
                padding-left: 50%;
                border: none;
                border-bottom: 1px solid var(--border);
            }

            td:before {
                content: attr(data-label);
                position: absolute;
                left: 1rem;
                width: calc(50% - 2rem);
                text-align: left;
                font-weight: 600;
                color: var(--main);
            }

            td:last-child {
                border-bottom: none;
            }
        }

        .hamburger-menu-btn {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: -250px;
            width: 250px;
            height: 100%;
            background: var(--main);
            padding-top: 60px;
            transition: left 0.3s ease;
            z-index: 1000;
        }

        .sidebar.active {
            left: 0;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 1rem;
        }

        .sidebar-nav button {
            background: none;
            border: none;
            color: var(--cor-bege-claro);
            padding: 1rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-align: left;
        }

        .sidebar-nav button:hover {
            background: var(--cor-dourado);
            color: var(--cor-texto-escuro);
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .overlay.active {
            display: block;
        }

        @media(max-width: 1024px) {
            header nav {
                display: none;
            }

            .hamburger-menu-btn {
                display: block;
            }
        }

        /* Ajustes extras para telas muito pequenas */
        @media (max-width: 480px) {
            header {
                flex-direction: column;
                align-items: flex-start;
                padding: 1rem;
            }

            header h1 {
                margin-bottom: 0.5rem;
            }

            .filter-bar,
            .section-header {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }

            #login-panel {
                max-width: 100%;
                margin: 5vh 1rem;
                padding: 6vw 4vw;
            }

            .container {
                padding: 1rem 0.5rem;
            }

            .modal {
                width: 95%;
                padding: 4vw;
            }

            #painel-cards {
                grid-template-columns: 1fr;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .sidebar {
                width: 200px;
            }
        }
    </style>
</head>

<body>

    <div id="login-panel">
        <h2><i class="fa-solid fa-scale-balanced"></i> Login do Advogado</h2>
        <div class="form-group">
            <label for="login-email">E-mail</label>
            <input id="login-email" type="email" placeholder="E-mail" required>
        </div>
        <div class="form-group">
            <label for="login-senha">Senha</label>
            <input id="login-senha" type="password" placeholder="Senha" required>
        </div>
        <button id="btnLogin" class="btn" style="width: 100%;">Entrar</button>
        <div id="login-erro"></div>
        <p style="text-align:center; margin-top:1.8rem; font-size: var(--fs-base); color:#666;">
            Primeiro acesso? <a href="#" id="btnCriarConta" style="color:var(--accent); font-weight:600;">Criar
                conta</a>
        </p>
    </div>

    <div id="app" style="display:none">
        <header>
            <button id="hamburger-menu" class="hamburger-menu-btn">
                <i class="fa fa-bars"></i>
            </button>
            <h1><i class="fa-solid fa-scale-balanced" style="color: var(--success);"></i> Painel Jur√≠dico</h1>
            <nav>
                <button id="nav0" class="active" onclick="abrirTab(0)"><i class="fa fa-chart-pie"></i> Painel</button>
                <button id="nav1" onclick="abrirTab(1)"><i class="fa fa-briefcase"></i> Casos</button>
                <button id="nav2" onclick="abrirTab(2)"><i class="fa fa-users"></i> Clientes</button>
                <button id="nav3" onclick="abrirTab(3)"><i class="fa fa-folder-open"></i> Documentos</button>
                <button id="nav4" onclick="abrirTab(4)"><i class="fa fa-calendar-alt"></i> Agenda</button>
                <button id="nav5" onclick="abrirTab(5)"><i class="fa fa-tasks"></i> Tarefas</button>
                <button id="nav6" onclick="abrirTab(6)"><i class="fa fa-hand-holding-dollar"></i> Financeiro</button>
                <button id="nav7" onclick="abrirTab(7)"><i class="fa fa-users"></i> Casos por Clientes</button>
                <button id="nav8" onclick="abrirTab(8)"><i class="fa fa-chart-line"></i> An√°lises Gr√°ficas</button>
            </nav>
            <button id="btnLogout" class="btn" style="background: #fff1f3; color:#d43c5e;">Sair <i
                    class="fa fa-sign-out-alt"></i></button>
        </header>

        <aside id="sidebar" class="sidebar">
            <nav class="sidebar-nav">
                <button id="nav0-sidebar" class="active" onclick="abrirTab(0); closeSidebar();"><i class="fa fa-chart-pie"></i> Painel</button>
                <button id="nav1-sidebar" onclick="abrirTab(1); closeSidebar();"><i class="fa fa-briefcase"></i> Casos</button>
                <button id="nav2-sidebar" onclick="abrirTab(2); closeSidebar();"><i class="fa fa-users"></i> Clientes</button>
                <button id="nav3-sidebar" onclick="abrirTab(3); closeSidebar();"><i class="fa fa-folder-open"></i> Documentos</button>
                <button id="nav4-sidebar" onclick="abrirTab(4); closeSidebar();"><i class="fa fa-calendar-alt"></i> Agenda</button>
                <button id="nav5-sidebar" onclick="abrirTab(5); closeSidebar();"><i class="fa fa-tasks"></i> Tarefas</button>
                <button id="nav6-sidebar" onclick="abrirTab(6); closeSidebar();"><i class="fa fa-hand-holding-dollar"></i> Financeiro</button>
                <button id="nav7-sidebar" onclick="abrirTab(7); closeSidebar();"><i class="fa fa-users"></i> Casos por Clientes</button>
                <button id="nav8-sidebar" onclick="abrirTab(8); closeSidebar();"><i class="fa fa-chart-line"></i> An√°lises Gr√°ficas</button>
            </nav>
        </aside>

        <div id="overlay" class="overlay"></div>

        <main class="container">
            <div id="notificacoes"></div>

            <!-- TAB: PAINEL GERAL -->
            <div class="tab-content active" id="tab0">
                <div class="section-header">
                    <h2>Vis√£o Geral</h2>
                </div>
                <div class="dashboard-grid">
                    <div class="card"><i class="icon fa fa-users"></i>
                        <div class="value" id="total-clientes">0</div>
                        <div class="label">Total de Clientes</div>
                    </div>
                    <div class="card"><i class="icon fa fa-briefcase"></i>
                        <div class="value" id="casos-ativos">0</div>
                        <div class="label">Casos Ativos</div>
                    </div>
                    <div class="card"><i class="icon fa fa-calendar-check"></i>
                        <div class="value" id="eventos-agendados">0</div>
                        <div class="label">Eventos Agendados</div>
                    </div>
                    <div class="card"><i class="icon fa fa-hand-holding-dollar"></i>
                        <div class="value" id="total-a-receber">R$ 0,00</div>
                        <div class="label">Total a Receber</div>
                    </div>
                </div>
                <div class="calendar-container">
                    <div id="calendar"></div>
                </div>
            </div>

            <!-- TAB: CASOS -->
            <div class="tab-content" id="tab1">
                <div class="section-header">
                    <h2>Casos & Processos</h2>
                </div>
                <div class="filter-bar">
                    <input id="buscar-caso" type="text" placeholder="Buscar por n¬∫ do processo, cliente, partes‚Ä¶"
                        onkeyup="renderCasos()">
                    <select id="filtro-caso-status" onchange="renderCasos()">
                        <option value="">Todos os Status</option>
                        <option value="Ativo">Ativo</option>
                        <option value="Conclu√≠do">Conclu√≠do</option>
                        <option value="Arquivado">Arquivado</option>
                    </select>
                    <button class="btn btn-success" onclick="abrirModalCaso()"><i class="fa fa-plus"></i> Novo
                        Caso</button>
                    <button class="btn btn-info" onclick="exportarDados('casos')"><i class="fa fa-download"></i> Exportar CSV</button>
                </div>
                <div class="table-wrapper" id="tabela-casos"></div>
            </div>

            <!-- TAB: CLIENTES -->
            <div class="tab-content" id="tab2">
                <div class="section-header">
                    <h2>Clientes</h2>
                </div>
                <div class="filter-bar">
                    <input id="buscar-cliente" type="text" placeholder="Buscar por nome, e-mail, telefone‚Ä¶"
                        onkeyup="renderClientes()">
                    <button class="btn btn-success" onclick="abrirModalCliente()"><i class="fa fa-plus"></i> Novo
                        Cliente</button>
                    <button class="btn btn-info" onclick="exportarDados('clientes')"><i class="fa fa-download"></i> Exportar CSV</button>
                </div>
                <div class="table-wrapper" id="tabela-clientes"></div>
            </div>

            <!-- TAB: DOCUMENTOS -->
            <div class="tab-content" id="tab3">
                <div class="section-header">
                    <h2>Gest√£o de Documentos</h2>
                </div>
                <div class="filter-bar">
                    <select id="doc-filtro-cliente" onchange="renderDocumentos()">
                        <option value="">Filtrar por cliente</option>
                    </select>
                    <select id="doc-filtro-caso" onchange="renderDocumentos()">
                        <option value="">Filtrar por caso</option>
                    </select>
                    <button class="btn btn-success" onclick="abrirModalDocumento()"><i class="fa fa-upload"></i> Anexar
                        Documento</button>
                    <button class="btn btn-info" onclick="exportarDados('docs')"><i class="fa fa-download"></i> Exportar CSV</button>
                </div>
                <div class="table-wrapper" id="tabela-documentos"></div>
            </div>

            <!-- TAB: AGENDA -->
            <div class="tab-content" id="tab4">
                <div class="section-header">
                    <h2>Agenda & Prazos</h2>
                    <button class="btn btn-success" onclick="abrirModalEvento()"><i class="fa fa-calendar-plus"></i>
                        Novo Evento</button>
                </div>
                <div class="filter-bar">
                    <input id="agenda-filtro-data" type="date" onchange="renderAgenda()">
                    <select id="agenda-filtro-tipo" onchange="renderAgenda()">
                        <option value="">Todos os Tipos</option>
                        <option>Audi√™ncia</option>
                        <option>Reuni√£o</option>
                        <option>Prazo Processual</option>
                        <option>Outro</option>
                    </select>
                    <button class="btn btn-info" onclick="exportarDados('agenda')"><i class="fa fa-download"></i> Exportar CSV</button>
                </div>
                <div class="table-wrapper" id="tabela-agenda"></div>
            </div>

            <!-- TAB: TAREFAS -->
            <div class="tab-content" id="tab5">
                <div class="section-header">
                    <h2>Controle de Tarefas</h2>
                    <button class="btn btn-success" onclick="abrirModalTarefa()"><i class="fa fa-plus"></i> Nova
                        Tarefa</button>
                </div>
                <div class="filter-bar">
                    <select id="filtro-tarefa-status" onchange="renderTarefas()">
                        <option value="Pendente">Pendentes</option>
                        <option value="">Todas</option>
                        <option value="Conclu√≠da">Conclu√≠das</option>
                    </select>
                    <select id="filtro-tarefa-prioridade" onchange="renderTarefas()">
                        <option value="">Todas as Prioridades</option>
                        <option>Alta</option>
                        <option>M√©dia</option>
                        <option>Baixa</option>
                    </select>
                    <button class="btn btn-info" onclick="exportarDados('tarefas')"><i class="fa fa-download"></i> Exportar CSV</button>
                </div>
                <div class="table-wrapper" id="tabela-tarefas"></div>
            </div>

            <!-- TAB: FINANCEIRO -->
            <div class="tab-content" id="tab6">
                <div class="section-header">
                    <h2>Financeiro</h2>
                </div>
                <div id="resumo-financeiro" class="painel-cards"></div>
                <div class="section-header" style="margin-top: 2.5rem; margin-bottom: 1rem;">
                    <h3 style="font-size: var(--fs-h3);">Hist√≥rico de Lan√ßamentos</h3>
                    <div class="filter-bar" style="margin-bottom: 0;">
                        <button class="btn btn-success" onclick="abrirModalFin('Receber')"><i class="fa fa-plus"></i>
                            Nova Receita</button>
                        <button class="btn btn-danger" onclick="abrirModalFin('Pagar')"><i class="fa fa-minus"></i> Nova
                            Despesa</button>
                        <button class="btn btn-info" onclick="exportarDados('fin')"><i class="fa fa-download"></i> Exportar CSV</button>
                    </div>
                </div>
                <div class="table-wrapper" id="tabela-financeiro"></div>
            </div>



            <!-- TAB: CASOS POR CLIENTE -->
            <div class="tab-content" id="tab7">
                <div class="section-header">
                    <h2>Casos por Cliente</h2>
                </div>
                <div class="filter-bar">
                    <input id="buscar-casos-por-cliente" type="text" placeholder="Buscar por nome do cliente..."
                        onkeyup="renderCasosPorCliente()">
                </div>
                <div id="casos-por-cliente-container"></div>
            </div>

            <!-- TAB: AN√ÅLISES GR√ÅFICAS -->
            <div class="tab-content" id="tab8">
                <div id="chart-relatorio"></div>
            </div>
        </main>
    </div>

    <!-- ========= MODAIS ========= -->
    <div class="modal-bg" id="modal-caso">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modal-caso-titulo">Novo Caso</h3><button class="close-modal"
                    onclick="fecharModal('modal-caso')">&times;</button>
            </div>
            <form onsubmit="salvarCaso(event);">
                <input type="hidden" id="caso-id">
                <div class="form-group"><label for="caso-cliente">Cliente *</label><select id="caso-cliente"
                        required></select></div>
                <div class="form-group"><label for="caso-numero">N¬∫ do Processo *</label><input id="caso-numero"
                        type="text" maxlength="60" required></div>
                <div class="form-group"><label for="caso-partes">Partes Envolvidas</label><textarea id="caso-partes"
                        placeholder="Autor, r√©u, terceiro..." rows="3"></textarea></div>
                <div class="form-group"><label for="caso-responsavel">Advogado Respons√°vel</label><input
                        id="caso-responsavel" type="text"></div>
                <div class="form-group"><label for="caso-data">Data de Abertura</label><input id="caso-data"
                        type="date"></div>
                <div class="form-group"><label for="caso-status">Status</label><select id="caso-status">
                        <option>Ativo</option>
                        <option>Conclu√≠do</option>
                        <option>Arquivado</option>
                    </select></div>
                <div class="modal-footer"><button type="submit" class="btn btn-success"><i class="fa fa-save"></i>
                        Salvar</button></div>
            </form>
        </div>
    </div>
    <div class="modal-bg" id="modal-cliente">
        <div class="modal" style="max-width: 550px;">
            <div class="modal-header">
                <h3 id="modal-cliente-titulo">Novo Cliente</h3><button class="close-modal"
                    onclick="fecharModal('modal-cliente')">&times;</button>
            </div>
            <form onsubmit="salvarCliente(event);">
                <input type="hidden" id="cliente-id">
                <div class="form-group"><label for="cliente-nome">Nome Completo *</label><input id="cliente-nome"
                        type="text" required></div>
                <div class="form-group"><label for="cliente-email">E-mail</label><input id="cliente-email" type="email">
                </div>
                <div class="form-group"><label for="cliente-fone">Telefone</label><input id="cliente-fone" type="tel">
                </div>
                <div class="form-group"><label for="cliente-notas">Anota√ß√µes / Prefer√™ncias</label><textarea
                        id="cliente-notas" rows="4"></textarea></div>
                <div class="modal-footer"><button type="submit" class="btn btn-success"><i class="fa fa-save"></i>
                        Salvar</button></div>
            </form>
        </div>
    </div>
    <div class="modal-bg" id="modal-documento">
        <div class="modal">
            <div class="modal-header">
                <h3>Anexar Documento</h3><button class="close-modal"
                    onclick="fecharModal('modal-documento')">&times;</button>
            </div>
            <form onsubmit="salvarDocumento(event);">
                <p style="font-size: .85rem; color: var(--muted-text); margin-bottom: 1rem;">Anexe arquivos a um cliente
                    ou caso. Os arquivos s√£o salvos na nuvem de forma segura.</p>
                <input type="hidden" id="doc-id">
                <div class="form-group"><label for="doc-cliente">Cliente *</label><select id="doc-cliente"
                        required></select></div>
                <div class="form-group"><label for="doc-caso">Vincular ao Caso (opcional)</label><select
                        id="doc-caso"></select></div>
                <div class="form-group"><label for="doc-titulo">T√≠tulo / Descri√ß√£o *</label><input id="doc-titulo"
                        type="text" required></div>
                <div class="form-group"><label for="doc-file">Arquivo *</label><input id="doc-file" type="file"
                        accept=".pdf,.doc,.docx,.jpg,.png,.jpeg,.xls,.xlsx" required></div>
                <div class="modal-footer"><button type="submit" class="btn btn-success"><i class="fa fa-save"></i>
                        Salvar</button></div>
            </form>
        </div>
    </div>
    <div class="modal-bg" id="modal-evento">
        <div class="modal">
            <div class="modal-header">
                <h3 id="evento-modal-titulo">Novo Evento / Prazo</h3><button class="close-modal"
                    onclick="fecharModal('modal-evento')">&times;</button>
            </div>
            <form onsubmit="salvarEvento(event);">
                <input type="hidden" id="evento-id">
                <div class="form-group"><label for="evento-titulo">T√≠tulo *</label><input id="evento-titulo" type="text"
                        required></div>
                <div class="form-group"><label for="evento-tipo">Tipo de Evento *</label><select id="evento-tipo"
                        required>
                        <option>Audi√™ncia</option>
                        <option>Reuni√£o</option>
                        <option>Prazo Processual</option>
                        <option>Outro</option>
                    </select></div>
                <div class="form-group"><label for="evento-datahora">Data e Hora *</label><input id="evento-datahora"
                        type="datetime-local" required></div>
                <div class="form-group"><label for="evento-local">Local / Link</label><input id="evento-local"
                        type="text" placeholder="Ex: F√≥rum Central, link da chamada..."></div>
                <div class="form-group"><label for="evento-cliente">Vincular ao Cliente</label><select
                        id="evento-cliente"
                        onchange="populateSelect('evento-caso', 'casos', 'id', 'numero', `cliente_id.eq.${this.value}`, 'Nenhum')"></select>
                </div>
                <div class="form-group"><label for="evento-caso">Vincular ao Caso</label><select
                        id="evento-caso"></select></div>
                <div class="form-group"><label for="evento-status">Status</label><select id="evento-status">
                        <option>Agendado</option>
                        <option>Realizado</option>
                        <option>Cancelado</option>
                    </select></div>
                <div class="form-group"><label for="evento-descricao">Descri√ß√£o</label><textarea id="evento-descricao"
                        rows="3"></textarea></div>
                <div class="modal-footer"><button type="submit" class="btn btn-success"><i class="fa fa-save"></i>
                        Salvar</button></div>
            </form>
        </div>
    </div>
    <div class="modal-bg" id="modal-tarefa">
        <div class="modal">
            <div class="modal-header">
                <h3 id="tarefa-modal-titulo">Nova Tarefa</h3><button class="close-modal"
                    onclick="fecharModal('modal-tarefa')">&times;</button>
            </div>
            <form onsubmit="salvarTarefa(event);">
                <input type="hidden" id="tarefa-id">
                <input type="hidden" id="tarefa-status">
                <div class="form-group"><label for="tarefa-descricao">Descri√ß√£o *</label><textarea id="tarefa-descricao"
                        rows="3" required></textarea></div>
                <div class="form-group"><label for="tarefa-prioridade">Prioridade</label><select id="tarefa-prioridade">
                        <option>Baixa</option>
                        <option>M√©dia</option>
                        <option>Alta</option>
                    </select></div>
                <div class="form-group"><label for="tarefa-prazo">Data do Prazo</label><input id="tarefa-prazo"
                        type="date"></div>
                <div class="form-group"><label for="tarefa-cliente">Vincular ao Cliente</label><select
                        id="tarefa-cliente"
                        onchange="populateSelect('tarefa-caso', 'casos', 'id', 'numero', `cliente_id.eq.${this.value}`, 'Nenhum')"></select>
                </div>
                <div class="form-group"><label for="tarefa-caso">Vincular ao Caso</label><select
                        id="tarefa-caso"></select></div>
                <div class="modal-footer"><button type="submit" class="btn btn-success"><i class="fa fa-save"></i>
                        Salvar</button></div>
            </form>
        </div>
    </div>
    <div class="modal-bg" id="modal-fin">
        <div class="modal">
            <div class="modal-header">
                <h3 id="fin-titulo">Novo Lan√ßamento</h3><button class="close-modal"
                    onclick="fecharModal('modal-fin')">&times;</button>
            </div>
            <form onsubmit="salvarFin(event);">
                <input type="hidden" id="fin-id"><input type="hidden" id="fin-tipo">
                <div class="form-group"><label for="fin-descricao">Descri√ß√£o *</label><input id="fin-descricao"
                        type="text" required></div>
                <div class="form-group"><label for="fin-categoria">Categoria *</label><select id="fin-categoria"
                        required>
                        <option>Honor√°rios</option>
                        <option>Custas Processuais</option>
                        <option>Acordo</option>
                        <option>Servi√ßos de Terceiros</option>
                        <option>Despesas Gerais</option>
                        <option>Outra</option>
                    </select></div>
                <div class="form-group"><label for="fin-valor">Valor (R$) *</label><input id="fin-valor" type="number"
                        step="0.01" placeholder="Ex: 1500.50" required></div>
                <div class="form-group"><label for="fin-data">Data *</label><input id="fin-data" type="date" required>
                </div>
                <div class="form-group"><label for="fin-status">Status Pagamento</label><select id="fin-status">
                        <option>Pendente</option>
                        <option>Pago</option>
                        <option>Vencido</option>
                    </select></div>
                <div class="form-group"><label for="fin-cliente">Vincular ao Cliente</label><select id="fin-cliente"
                        onchange="populateSelect('fin-caso', 'casos', 'id', 'numero', `cliente_id.eq.${this.value}`, 'Nenhum')"></select>
                </div>
                <div class="form-group"><label for="fin-caso">Vincular ao Caso</label><select id="fin-caso"></select>
                </div>
                <div class="modal-footer"><button type="submit" class="btn btn-success"><i class="fa fa-save"></i>
                        Salvar</button></div>
            </form>
        </div>
    </div>

    <!-- Google Apps Script runtime already provides google.script.run -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <script>
        // =================================================================================
        // PAINEL JUR√çDICO - SCRIPT COMPLETO (Vers√£o Supabase) - SPINNERS
        // =================================================================================

        const $ = (s) => document.querySelector(s);
        const $$ = (s) => document.querySelectorAll(s);

        // -- CONFIGURA√á√ÉO DO APPS SCRIPT --
        // As opera√ß√µes de dados s√£o realizadas por fun√ß√µes server-side em Code.gs
        function gsGetRows(sheet) {
            return new Promise((res, rej) => {
                google.script.run.withSuccessHandler(data => {
                    res(Array.isArray(data) ? data : []);
                }).withFailureHandler(rej).getRows(sheet);
            });
        }

        function gsAddRow(sheet, row) {
            return new Promise((res, rej) => {
                google.script.run.withSuccessHandler(res).withFailureHandler(rej).addRow(sheet, row);
            });
        }

        function gsDeleteRow(sheet, id) {
            return new Promise((res, rej) => {
                google.script.run.withSuccessHandler(res).withFailureHandler(rej).deleteRow(sheet, id);
            });
        }

        function gsUpdateRow(sheet, id, row) {
            return new Promise((res, rej) => {
                google.script.run.withSuccessHandler(res).withFailureHandler(rej).updateRow(sheet, id, row);
            });
        }

        function gsUploadDocument(name, base64) {
            return new Promise((res, rej) => {
                google.script.run.withSuccessHandler(res).withFailureHandler(rej).uploadDocument(name, base64);
            });
        }

        function gsLogin(email, senha) {
            return new Promise((res, rej) => {
                google.script.run.withSuccessHandler(res).withFailureHandler(rej).login(email, senha);
            });
        }


        async function getRowById(table, id) {
            const rows = await gsGetRows(table);
            return rows.find(r => String(r.id) === String(id));
        }

        // -- INST√ÇNCIAS DOS GR√ÅFICOS --
        let overviewChart, reportsChart;

        /* ------------- HELPERS GLOBAIS ------------- */
        const SPINNER_HTML = '<div class="spinner"></div>';
        const fmtDate = (d) => d ? new Date(d).toLocaleDateString('pt-BR', { timeZone: 'UTC' }) : '';
        const fmtDateTime = (d) => d ? new Date(d).toLocaleString('pt-BR', { timeZone: 'UTC' }) : '';
        const fmtCurrency = (v) => Number(v || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        function showNotif(type, msg) {
            const icons = { success: 'fa-check-circle', danger: 'fa-times-circle', info: 'fa-info-circle' };
            const div = document.createElement('div');
            div.className = `notif ${type}`;
            div.innerHTML = `<i class="fa ${icons[type]}"></i><span>${msg}</span>`;
            $('#notificacoes').appendChild(div);
            setTimeout(() => {
                div.style.animation = 'slideOut .4s forwards';
                setTimeout(() => div.remove(), 400);
            }, 4000);
        }

        function fecharModal(modalId) { $(`#${modalId}`).classList.remove('active'); }

        async function populateSelect(selectId, tableName, valueCol, textCol, filter = '', placeholder = 'Selecione', selectedValue = null) {
            const select = $(`#${selectId}`);
            select.innerHTML = `<option value="">${placeholder}</option>`;
            try {
                let data = await gsGetRows(tableName);
                if (filter && filter.split('.').length === 3) {
                    const [column, op, value] = filter.split('.');
                    if (value) {
                        data = data.filter(r => op === 'eq' ? String(r[column]) === value : true);
                    }
                }
                data.sort((a, b) => (a[textCol] > b[textCol] ? 1 : -1));
                data.forEach(r => select.innerHTML += `<option value="${r[valueCol]}">${r[textCol]}</option>`);
                if (selectedValue) select.value = selectedValue;
            } catch (e) {
                console.error('Erro ao popular select:', e);
            }
        }

        /* ------------- FUN√á√ïES DE RENDERIZA√á√ÉO (COM SPINNERS) ------------- */

        async function loadDashboard() {
            $('#total-clientes').innerHTML = SPINNER_HTML;
            $('#casos-ativos').innerHTML = SPINNER_HTML;
            $('#eventos-agendados').innerHTML = SPINNER_HTML;
            $('#total-a-receber').innerHTML = SPINNER_HTML;

            try {
                const clientes = await gsGetRows('clientes');
                $('#total-clientes').innerText = clientes.length || 0;
            } catch (e) {
                console.error('Erro ao buscar total de clientes:', e);
                $('#total-clientes').innerText = 0;
            }

            try {
                const casos = await gsGetRows('casos') || [];
                $('#casos-ativos').innerText = casos.filter(c => c.status === 'Ativo').length || 0;
            } catch (e) {
                console.error('Erro ao buscar casos ativos:', e);
                $('#casos-ativos').innerText = 0;
            }

            try {
                const agenda = await gsGetRows('agenda') || [];
                $('#eventos-agendados').innerText = agenda.filter(a => a.status === 'Agendado').length || 0;
            } catch (e) {
                console.error('Erro ao buscar eventos agendados:', e);
                $('#eventos-agendados').innerText = 0;
            }

            try {
                const fin = await gsGetRows('fin') || [];
                const total = fin.reduce((s, r) => s + (r.tipo === 'Receber' && r.status_pg !== 'Pago' ? Number(r.valor || 0) : 0), 0);
                $('#total-a-receber').innerText = fmtCurrency(total);
            } catch (e) {
                console.error('Erro ao carregar resumo financeiro:', e);
                $('#total-a-receber').innerText = fmtCurrency(0);
            }

            // FullCalendar
            const calendarEl = $('#calendar');
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: window.innerWidth < 768 ? 'listWeek' : 'dayGridMonth',
                locale: 'pt-br',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
                },
                eventOrder: 'start,title',
                events: async (fetchInfo, successCallback, failureCallback) => {
                    try {
                        const [agenda, tarefas] = await Promise.all([
                            gsGetRows('agenda'),
                            gsGetRows('tarefas')
                        ]);
                        const events = [];
                        (agenda || []).forEach(ev => {
                            if (!ev.datahora) return;
                            const statusClass = (ev.status || '').toLowerCase().normalize('NFD').replace(/[^a-z0-9]/g, '');
                            events.push({
                                id: ev.id,
                                title: ev.titulo,
                                start: ev.datahora,
                                extendedProps: { ...ev, type: 'agenda' },
                                classNames: [`status-${statusClass}`]
                            });
                        });
                        (tarefas || []).forEach(t => {
                            if (!t.prazo) return;
                            const prioClass = (t.prioridade || '').toLowerCase().normalize('NFD').replace(/[^a-z0-9]/g, '');
                            events.push({
                                id: t.id,
                                title: t.descricao,
                                start: t.prazo,
                                extendedProps: { ...t, type: 'tarefa' },
                                classNames: [`prioridade-${prioClass}`]
                            });
                        });
                        successCallback(events);
                    } catch (e) {
                        console.error('Erro ao carregar eventos:', e);
                        failureCallback(e);
                    }
                },
                eventClick: function (info) {
                    if (info.event.extendedProps.type === 'agenda') {
                        abrirModalEvento(info.event.id);
                    } else if (info.event.extendedProps.type === 'tarefa') {
                        abrirModalTarefa(info.event.id);
                    }
                },
                eventContent: function(arg) {
                    let eventDetails = document.createElement('div');
                    let badges = '';
                    if (arg.event.extendedProps.type === 'agenda') {
                        if (arg.event.extendedProps.status) badges += `<span class="badge ${arg.event.extendedProps.status}">${arg.event.extendedProps.status}</span>`;
                        if (arg.event.extendedProps.tipo_evento) badges += `<span class="badge">${arg.event.extendedProps.tipo_evento}</span>`;
                    } else if (arg.event.extendedProps.type === 'tarefa') {
                        if (arg.event.extendedProps.prioridade) badges += `<span class="badge ${arg.event.extendedProps.prioridade}">${arg.event.extendedProps.prioridade}</span>`;
                        if (arg.event.extendedProps.status) badges += `<span class="badge ${arg.event.extendedProps.status}">${arg.event.extendedProps.status}</span>`;
                    }

                    eventDetails.innerHTML = `
                        <div class="fc-event-main-frame">
                            <div class="fc-event-title-container">
                                <div class="fc-event-title">${arg.event.title}</div>
                            </div>
                        </div>
                        <div class="fc-event-details">
                            ${badges}
                        </div>
                    `;
                    return { domNodes: [eventDetails] };
                },
                windowResize: function(view) {
                    if (window.innerWidth < 768) {
                        calendar.changeView('listWeek');
                    } else {
                        calendar.changeView('dayGridMonth');
                    }
                }
            });
            calendar.render();
        }

        async function renderCasos() {
            $('#tabela-casos').innerHTML = SPINNER_HTML;
            const busca = $('#buscar-caso').value.toLowerCase();
            const status = $('#filtro-caso-status').value;
            try {
                let casos = await gsGetRows('casos') || [];
                const clientes = await gsGetRows('clientes') || [];
                if (status) casos = casos.filter(c => (c.status || '').toLowerCase() === status.toLowerCase());
                if (busca) {
                    casos = casos.filter(c => {
                        const cliente = clientes.find(cl => cl.id == c.cliente_id) || {};
                        return (c.numero || '').toLowerCase().includes(busca) ||
                            (c.partes || '').toLowerCase().includes(busca) ||
                            (cliente.nome || '').toLowerCase().includes(busca);
                    });
                }
                casos.sort((a, b) => (b.id || 0) - (a.id || 0));

                const table = $('#tabela-casos');
                if (!casos.length) {
                    table.innerHTML = `<p style="text-align:center; padding: 2rem;">Nenhum caso encontrado.</p>`;
                    return;
                }
                table.innerHTML = `<table><thead><tr><th>N¬∫ Processo</th><th>Cliente</th><th>Partes</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody>
                ${casos.map(r => {
                    const cliente = clientes.find(cl => cl.id == r.cliente_id) || {};
                    return `<tr>
                        <td data-label="N¬∫ Processo">${r.numero}</td>
                        <td data-label="Cliente">${cliente.nome || ''}</td>
                        <td data-label="Partes">${r.partes || ''}</td>
                        <td data-label="Status"><span class="badge ${r.status}">${r.status}</span></td>
                        <td data-label="A√ß√µes"><div class="actions">
                            <button onclick="abrirModalCaso(${r.id})" title="Editar"><i class="fa fa-edit"></i></button>
                            <button onclick="delRow('casos', ${r.id}, renderCasos)" title="Excluir"><i class="fa fa-trash"></i></button>
                        </div></td>
                    </tr>`;
                }).join('')}</tbody></table>`;
            } catch (e) {
                console.error('Erro ao renderizar casos:', e);
                $('#tabela-casos').innerHTML = `<p style="text-align:center; padding: 2rem;">Erro ao carregar casos.</p>`;
            }
        }

        async function renderClientes() {
            $('#tabela-clientes').innerHTML = SPINNER_HTML;
            const busca = $('#buscar-cliente').value.toLowerCase();
            let data = [];
            let error = null;
            try {
                data = await gsGetRows('clientes') || [];
                if (busca) data = data.filter(r =>
                    (r.nome || '').toLowerCase().includes(busca) ||
                    (r.email || '').toLowerCase().includes(busca) ||
                    (r.fone || '').toLowerCase().includes(busca)
                );
                data.sort((a, b) => (a.nome > b.nome ? 1 : -1));
            } catch (e) {
                error = e;
            }

            const table = $('#tabela-clientes');
            if (error || !data || !data.length) {
                table.innerHTML = `<p style="text-align:center; padding: 2rem;">Nenhum cliente encontrado.</p>`;
                if (error) console.error('Erro ao renderizar clientes:', error);
                return;
            }
            table.innerHTML = `<table><thead><tr><th>Nome</th><th>E-mail</th><th>Telefone</th><th>A√ß√µes</th></tr></thead><tbody>
            ${data.map(r => `<tr>
                <td data-label="Nome">${r.nome}</td>
                <td data-label="E-mail">${r.email || ''}</td>
                <td data-label="Telefone">${r.fone || ''}</td>
                <td data-label="A√ß√µes"><div class="actions">
                    <button onclick="abrirModalCliente(${r.id})" title="Editar"><i class="fa fa-edit"></i></button>
                    <button onclick="delRow('clientes', ${r.id}, renderClientes)" title="Excluir"><i class="fa fa-trash"></i></button>
                </div></td>
            </tr>`).join('')}</tbody></table>`;
        }

        async function renderDocumentos() {
            $('#tabela-documentos').innerHTML = SPINNER_HTML;
            await populateSelect('doc-filtro-cliente', 'clientes', 'id', 'nome', '', 'Filtrar por cliente', $('#doc-filtro-cliente').value);
            await populateSelect('doc-filtro-caso', 'casos', 'id', 'numero', '', 'Filtrar por caso', $('#doc-filtro-caso').value);
            const clienteId = $('#doc-filtro-cliente').value;
            const casoId = $('#doc-filtro-caso').value;
            try {
                let docs = await gsGetRows('docs') || [];
                const clientes = await gsGetRows('clientes') || [];
                const casos = await gsGetRows('casos') || [];
                if (clienteId) docs = docs.filter(d => String(d.cliente_id) === clienteId);
                if (casoId) docs = docs.filter(d => String(d.caso_id) === casoId);
                docs.sort((a, b) => (b.id || 0) - (a.id || 0));
                const table = $('#tabela-documentos');
                if (!docs.length) {
                    table.innerHTML = `<p style="text-align:center; padding: 2rem;">Nenhum documento encontrado.</p>`;
                    return;
                }
                table.innerHTML = `<table><thead><tr><th>T√≠tulo</th><th>Cliente</th><th>Caso</th><th>A√ß√µes</th></tr></thead><tbody>
                ${docs.map(d => {
                    const cli = clientes.find(c => c.id == d.cliente_id) || {};
                    const ca = casos.find(c => c.id == d.caso_id) || {};
                    return `<tr>
                        <td data-label="T√≠tulo">${d.titulo || ''}</td>
                        <td data-label="Cliente">${cli.nome || ''}</td>
                        <td data-label="Caso">${ca.numero || ''}</td>
                        <td data-label="A√ß√µes"><div class="actions">
                            <button onclick="downloadDoc('${d.file_url}')" title="Baixar"><i class="fa fa-download"></i></button>
                            <button onclick="delRow('docs', ${d.id}, renderDocumentos)" title="Excluir"><i class="fa fa-trash"></i></button>
                        </div></td>
                    </tr>`;
                }).join('')}</tbody></table>`;
            } catch (e) {
                console.error('Erro ao renderizar documentos:', e);
                $('#tabela-documentos').innerHTML = `<p style="text-align:center; padding: 2rem;">Erro ao carregar documentos.</p>`;
            }
        }

        async function renderAgenda() {
            $('#tabela-agenda').innerHTML = SPINNER_HTML;
            const filtroData = $('#agenda-filtro-data').value;
            const filtroTipo = $('#agenda-filtro-tipo').value;
            try {
                let agenda = await gsGetRows('agenda') || [];
                const clientes = await gsGetRows('clientes') || [];
                const casos = await gsGetRows('casos') || [];
                if (filtroData) agenda = agenda.filter(a => String(a.datahora || '').startsWith(filtroData));
                if (filtroTipo) agenda = agenda.filter(a => a.tipo_evento === filtroTipo);
                agenda.sort((a, b) => new Date(a.datahora) - new Date(b.datahora));
                const table = $('#tabela-agenda');
                if (!agenda.length) {
                    table.innerHTML = `<p style="text-align:center; padding: 2rem;">Nenhum evento encontrado.</p>`;
                    return;
                }
                table.innerHTML = `<table><thead><tr><th>T√≠tulo</th><th>Data</th><th>Cliente</th><th>Caso</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody>
                ${agenda.map(ev => {
                    const cli = clientes.find(c => c.id == ev.cliente_id) || {};
                    const ca = casos.find(c => c.id == ev.caso_id) || {};
                    return `<tr>
                        <td data-label="T√≠tulo">${ev.titulo}</td>
                        <td data-label="Data">${fmtDateTime(ev.datahora)}</td>
                        <td data-label="Cliente">${cli.nome || ''}</td>
                        <td data-label="Caso">${ca.numero || ''}</td>
                        <td data-label="Status"><span class="badge ${ev.status}">${ev.status}</span></td>
                        <td data-label="A√ß√µes"><div class="actions">
                            <button onclick="abrirModalEvento(${ev.id})" title="Editar"><i class="fa fa-edit"></i></button>
                            <button onclick="delRow('agenda', ${ev.id}, renderAgenda)" title="Excluir"><i class="fa fa-trash"></i></button>
                        </div></td>
                    </tr>`;
                }).join('')}</tbody></table>`;
            } catch (e) {
                console.error('Erro ao renderizar agenda:', e);
                $('#tabela-agenda').innerHTML = `<p style="text-align:center; padding: 2rem;">Erro ao carregar agenda.</p>`;
            }
        }

        async function renderTarefas() {
            $('#tabela-tarefas').innerHTML = SPINNER_HTML;
            const status = $('#filtro-tarefa-status').value;
            const prioridade = $('#filtro-tarefa-prioridade').value;
            try {
                let tarefas = await gsGetRows('tarefas') || [];
                const clientes = await gsGetRows('clientes') || [];
                const casos = await gsGetRows('casos') || [];
                if (status) tarefas = tarefas.filter(t => t.status === status);
                if (prioridade) tarefas = tarefas.filter(t => t.prioridade === prioridade);
                tarefas.sort((a, b) => new Date(a.prazo || 0) - new Date(b.prazo || 0));
                const table = $('#tabela-tarefas');
                if (!tarefas.length) {
                    table.innerHTML = `<p style="text-align:center; padding: 2rem;">Nenhuma tarefa encontrada.</p>`;
                    return;
                }
                table.innerHTML = `<table><thead><tr><th>Descri√ß√£o</th><th>Prazo</th><th>Prioridade</th><th>Cliente</th><th>Caso</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody>
                ${tarefas.map(t => {
                    const cli = clientes.find(c => c.id == t.cliente_id) || {};
                    const ca = casos.find(c => c.id == t.caso_id) || {};
                    const checked = t.status === 'Conclu√≠da' ? 'checked' : '';
                    return `<tr>
                        <td data-label="Descri√ß√£o">${t.descricao}</td>
                        <td data-label="Prazo">${fmtDate(t.prazo)}</td>
                        <td data-label="Prioridade"><span class="badge ${t.prioridade}">${t.prioridade}</span></td>
                        <td data-label="Cliente">${cli.nome || ''}</td>
                        <td data-label="Caso">${ca.numero || ''}</td>
                        <td data-label="Status"><span class="badge ${t.status}">${t.status}</span></td>
                        <td data-label="A√ß√µes"><div class="actions">
                            <input type="checkbox" ${checked} onchange="concluirTarefa(${t.id}, this.checked)" title="Concluir">
                            <button onclick="abrirModalTarefa(${t.id})" title="Editar"><i class="fa fa-edit"></i></button>
                            <button onclick="delRow('tarefas', ${t.id}, renderTarefas)" title="Excluir"><i class="fa fa-trash"></i></button>
                        </div></td>
                    </tr>`;
                }).join('')}</tbody></table>`;
            } catch (e) {
                console.error('Erro ao renderizar tarefas:', e);
                $('#tabela-tarefas').innerHTML = `<p style="text-align:center; padding: 2rem;">Erro ao carregar tarefas.</p>`;
            }
        }

        async function loadFinanceiro() {
            $('#resumo-financeiro').innerHTML = SPINNER_HTML;
            $('#tabela-financeiro').innerHTML = SPINNER_HTML;
            try {
                const fin = await gsGetRows('fin') || [];
                const clientes = await gsGetRows('clientes') || [];
                const casos = await gsGetRows('casos') || [];
                const aReceber = fin.filter(f => f.tipo === 'Receber' && f.status_pg !== 'Pago').reduce((s, f) => s + Number(f.valor || 0), 0);
                const aPagar = fin.filter(f => f.tipo === 'Pagar' && f.status_pg !== 'Pago').reduce((s, f) => s + Number(f.valor || 0), 0);
                $('#resumo-financeiro').innerHTML = `
                    <div class="card"><div class="icon"><i class="fa fa-arrow-down"></i></div><div class="value">${fmtCurrency(aReceber)}</div><div class="label">A Receber</div></div>
                    <div class="card"><div class="icon"><i class="fa fa-arrow-up"></i></div><div class="value">${fmtCurrency(aPagar)}</div><div class="label">A Pagar</div></div>
                `;
                fin.sort((a, b) => new Date(b.data) - new Date(a.data));
                const table = $('#tabela-financeiro');
                table.innerHTML = `<table><thead><tr><th>Descri√ß√£o</th><th>Valor</th><th>Data</th><th>Cliente</th><th>Caso</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody>
                ${fin.map(f => {
                    const cli = clientes.find(c => c.id == f.cliente_id) || {};
                    const ca = casos.find(c => c.id == f.caso_id) || {};
                    return `<tr>
                        <td data-label="Descri√ß√£o">${f.descricao}</td>
                        <td data-label="Valor">${fmtCurrency(f.valor)}</td>
                        <td data-label="Data">${fmtDate(f.data)}</td>
                        <td data-label="Cliente">${cli.nome || ''}</td>
                        <td data-label="Caso">${ca.numero || ''}</td>
                        <td data-label="Status"><span class="badge ${f.status_pg}">${f.status_pg}</span></td>
                        <td data-label="A√ß√µes"><div class="actions">
                            <button onclick="abrirModalFin('${f.tipo}', ${f.id})" title="Editar"><i class="fa fa-edit"></i></button>
                            <button onclick="delRow('fin', ${f.id}, loadFinanceiro)" title="Excluir"><i class="fa fa-trash"></i></button>
                        </div></td>
                    </tr>`;
                }).join('')}</tbody></table>`;
            } catch (e) {
                console.error('Erro ao carregar financeiro:', e);
                $('#resumo-financeiro').innerHTML = '';
                $('#tabela-financeiro').innerHTML = `<p style="text-align:center; padding: 2rem;">Erro ao carregar dados.</p>`;
            }
        }

        async function loadRelatorios() {
            const container = $('#chart-relatorio');
            if (!container) return;
            container.innerHTML = '<p style="text-align:center; padding: 2rem;">Carregando...</p>';

            try {
                const [casos, tarefas, fin] = await Promise.all([
                    gsGetRows('casos'),
                    gsGetRows('tarefas'),
                    gsGetRows('fin')
                ]);

                container.innerHTML = `
                    <div class="charts-grid">
                        <div class="chart-box"><h3>Status dos Casos</h3><canvas id="casos-status-chart"></canvas></div>
                        <div class="chart-box"><h3>Prioridade das Tarefas</h3><canvas id="tarefas-prioridade-chart"></canvas></div>
                        <div class="chart-box"><h3>Evolu√ß√£o Financeira</h3><canvas id="fin-evolucao-chart"></canvas></div>
                    </div>
                `;

                const statusCounts = {};
                (casos || []).forEach(c => {
                    const s = c.status || 'Outro';
                    statusCounts[s] = (statusCounts[s] || 0) + 1;
                });
                new Chart($('#casos-status-chart'), {
                    type: 'pie',
                    data: {
                        labels: Object.keys(statusCounts),
                        datasets: [{
                            data: Object.values(statusCounts),
                            backgroundColor: ['#42a5f5', '#66bb6a', '#ffb74d', '#ab47bc']
                        }]
                    },
                    options: {
                        plugins: {
                            legend: { position: 'bottom' },
                            title: { display: true, text: 'Status dos Casos' }
                        }
                    }
                });

                const prioridadeCounts = { Alta: 0, M√©dia: 0, Baixa: 0 };
                (tarefas || []).forEach(t => {
                    const p = t.prioridade || 'Baixa';
                    prioridadeCounts[p] = (prioridadeCounts[p] || 0) + 1;
                });
                new Chart($('#tarefas-prioridade-chart'), {
                    type: 'bar',
                    data: {
                        labels: Object.keys(prioridadeCounts),
                        datasets: [{
                            label: 'Tarefas',
                            data: Object.values(prioridadeCounts),
                            backgroundColor: '#5D1A2A'
                        }]
                    },
                    options: {
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: 'Prioridade das Tarefas' }
                        },
                        scales: { y: { beginAtZero: true } }
                    }
                });

                const receitasPorMes = {}, despesasPorMes = {};
                (fin || []).forEach(f => {
                    if (!f.data) return;
                    const mes = new Date(f.data).toISOString().slice(0, 7);
                    if (f.tipo === 'Receber') {
                        receitasPorMes[mes] = (receitasPorMes[mes] || 0) + Number(f.valor || 0);
                    } else if (f.tipo === 'Pagar') {
                        despesasPorMes[mes] = (despesasPorMes[mes] || 0) + Number(f.valor || 0);
                    }
                });
                const meses = Array.from(new Set([...Object.keys(receitasPorMes), ...Object.keys(despesasPorMes)])).sort();
                new Chart($('#fin-evolucao-chart'), {
                    type: 'line',
                    data: {
                        labels: meses,
                        datasets: [
                            {
                                label: 'Receitas',
                                data: meses.map(m => receitasPorMes[m] || 0),
                                borderColor: '#4caf50',
                                backgroundColor: 'rgba(76, 175, 80, 0.2)',
                                tension: 0.3
                            },
                            {
                                label: 'Despesas',
                                data: meses.map(m => despesasPorMes[m] || 0),
                                borderColor: '#ef5350',
                                backgroundColor: 'rgba(239, 83, 80, 0.2)',
                                tension: 0.3
                            }
                        ]
                    },
                    options: {
                        plugins: {
                            legend: { position: 'bottom' },
                            title: { display: true, text: 'Evolu√ß√£o Financeira Mensal' }
                        }
                    }
                });
            } catch (e) {
                console.error('Erro ao carregar relat√≥rios:', e);
                container.innerHTML = '<p style="text-align:center; padding: 2rem;">Erro ao carregar dados.</p>';
            }
        }

        async function renderCasosPorCliente() {
            const container = $('#casos-por-cliente-container');
            container.innerHTML = SPINNER_HTML;
            const busca = $('#buscar-casos-por-cliente').value.toLowerCase();
            try {
                const clientes = await gsGetRows('clientes') || [];
                const casos = await gsGetRows('casos') || [];
                const filtered = busca ? clientes.filter(c => (c.nome || '').toLowerCase().includes(busca)) : clientes;
                const html = filtered.map(cl => {
                    const casosCliente = casos.filter(c => c.cliente_id == cl.id);
                    if (!casosCliente.length) return '';
                    return `<div class="cliente-card"><h3>${cl.nome}</h3><ul>${casosCliente.map(c => `<li><span>${c.numero}</span><span class="badge ${c.status}">${c.status}</span></li>`).join('')}</ul></div>`;
                }).join('');
                container.innerHTML = html || '<p style="text-align:center; padding: 2rem;">Nenhum resultado encontrado.</p>';
            } catch (e) {
                console.error('Erro ao renderizar casos por cliente:', e);
                container.innerHTML = '<p style="text-align:center; padding: 2rem;">Erro ao carregar dados.</p>';
            }
        }

        /* ------------- LISTA DE FUN√á√ïES DE RENDERIZA√á√ÉO ------------- */
        const renderFunctions = [loadDashboard, renderCasos, renderClientes, renderDocumentos, renderAgenda, renderTarefas, loadFinanceiro, renderCasosPorCliente, loadRelatorios];

        /* ------------- UI & NAVEGA√á√ÉO ------------- */
        function abrirTab(index) {
            $$('nav button').forEach(b => b.classList.remove('active'));
            $(`#nav${index}`).classList.add('active');
            $$('.tab-content').forEach(t => t.classList.remove('active'));
            $(`#tab${index}`).classList.add('active');
            if (renderFunctions[index]) {
                renderFunctions[index]();
            }
        }

        /* ------------- MODAIS E A√á√ïES DE SALVAMENTO ------------- */

        async function delRow(tableName, id, renderCallback) {
            if (!confirm('Excluir registro selecionado?')) return;
            try {
                await gsDeleteRow(tableName, id);
                showNotif('success', 'Registro exclu√≠do.');
                if (renderCallback) renderCallback();
                loadDashboard();
            } catch (e) {
                console.error('Erro ao excluir:', e);
                showNotif('danger', 'Erro ao excluir registro.');
            }
        }

        async function abrirModalCliente(id = null) {
            $('#modal-cliente form').reset();
            $('#cliente-id').value = '';
            if (id) {
                const cli = await getRowById('clientes', id);
                if (cli) {
                    $('#cliente-id').value = cli.id;
                    $('#cliente-nome').value = cli.nome || '';
                    $('#cliente-email').value = cli.email || '';
                    $('#cliente-fone').value = cli.fone || '';
                    $('#cliente-notas').value = cli.notas || '';
                }
            }
            $('#modal-cliente-titulo').innerText = id ? 'Editar Cliente' : 'Novo Cliente';
            $('#modal-cliente').classList.add('active');
        }

        async function salvarCliente(event) {
            event.preventDefault();
            const id = $('#cliente-id').value;
            const record = {
                nome: $('#cliente-nome').value,
                email: $('#cliente-email').value,
                fone: $('#cliente-fone').value,
                notas: $('#cliente-notas').value,
            };
            if (!record.nome) return showNotif('danger', 'O nome do cliente √© obrigat√≥rio.');

            try {
                if (id) {
                    await gsUpdateRow('clientes', id, record);
                    showNotif('success', 'Cliente atualizado!');
                } else {
                    await gsAddRow('clientes', record);
                    showNotif('success', 'Cliente salvo!');
                }
                fecharModal('modal-cliente');
                renderClientes();
                loadDashboard();
            } catch (e) {
                showNotif('danger', 'Erro: ' + e.message);
                console.error(e);
            }
        }

        async function abrirModalCaso(id = null) {
            $('#modal-caso form').reset();
            $('#caso-id').value = '';
            await populateSelect('caso-cliente', 'clientes', 'id', 'nome');
            if (id) {
                const caso = await getRowById('casos', id);
                if (caso) {
                    $('#caso-id').value = caso.id;
                    await populateSelect('caso-cliente', 'clientes', 'id', 'nome', '', 'Selecione', caso.cliente_id);
                    $('#caso-numero').value = caso.numero || '';
                    $('#caso-partes').value = caso.partes || '';
                    $('#caso-responsavel').value = caso.responsavel || '';
                    $('#caso-data').value = caso.data ? caso.data.split('T')[0] : '';
                    $('#caso-status').value = caso.status || 'Ativo';
                }
            }
            $('#modal-caso-titulo').innerText = id ? 'Editar Caso' : 'Novo Caso';
            $('#modal-caso').classList.add('active');
        }

        async function salvarCaso(event) {
            event.preventDefault();
            const id = $('#caso-id').value;
            const record = {
                cliente_id: $('#caso-cliente').value,
                numero: $('#caso-numero').value,
                partes: $('#caso-partes').value,
                responsavel: $('#caso-responsavel').value,
                data: $('#caso-data').value,
                status: $('#caso-status').value
            };
            if (!record.cliente_id || !record.numero) return showNotif('danger', 'Cliente e n¬∫ do processo s√£o obrigat√≥rios.');
            try {
                if (id) {
                    await gsUpdateRow('casos', id, record);
                    showNotif('success', 'Caso atualizado!');
                } else {
                    await gsAddRow('casos', record);
                    showNotif('success', 'Caso salvo!');
                }
                fecharModal('modal-caso');
                renderCasos();
                loadDashboard();
            } catch (e) {
                showNotif('danger', 'Erro: ' + e.message);
                console.error(e);
            }
        }

        async function abrirModalDocumento() {
            $('#modal-documento form').reset();
            $('#doc-id').value = '';
            await populateSelect('doc-cliente', 'clientes', 'id', 'nome');
            await populateSelect('doc-caso', 'casos', 'id', 'numero');
            $('#modal-documento').classList.add('active');
        }

        async function salvarDocumento(event) {
            event.preventDefault();
            const id = $('#doc-id').value;
            if (id) return showNotif('info', 'Edi√ß√£o de documentos n√£o dispon√≠vel nesta vers√£o.');
            const file = $('#doc-file').files[0];
            if (!file) return showNotif('danger', 'Selecione um arquivo.');
            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64 = e.target.result.split(',')[1];
                try {
                    const uploaded = await gsUploadDocument(file.name, base64);
                    const record = {
                        cliente_id: $('#doc-cliente').value,
                        caso_id: $('#doc-caso').value,
                        titulo: $('#doc-titulo').value,
                        file_id: uploaded.id,
                        file_nome: uploaded.name,
                        file_url: uploaded.url
                    };
                    await gsAddRow('docs', record);
                    showNotif('success', 'Documento salvo!');
                    fecharModal('modal-documento');
                    renderDocumentos();
                } catch (err) {
                    showNotif('danger', 'Erro: ' + err.message);
                    console.error(err);
                }
            };
            reader.readAsDataURL(file);
        }

        async function downloadDoc(id) {
            if (id) window.open(id, '_blank');
        }

        async function abrirModalEvento(id = null) {
            $('#modal-evento form').reset();
            $('#evento-id').value = '';
            await populateSelect('evento-cliente', 'clientes', 'id', 'nome');
            await populateSelect('evento-caso', 'casos', 'id', 'numero');
            if (id) {
                const ev = await getRowById('agenda', id);
                if (ev) {
                    $('#evento-id').value = ev.id;
                    $('#evento-titulo').value = ev.titulo || '';
                    $('#evento-tipo').value = ev.tipo_evento || 'Audi√™ncia';
                    $('#evento-datahora').value = ev.datahora ? ev.datahora.slice(0,16) : '';
                    $('#evento-local').value = ev.local || '';
                    await populateSelect('evento-cliente', 'clientes', 'id', 'nome', '', 'Selecione', ev.cliente_id);
                    await populateSelect('evento-caso', 'casos', 'id', 'numero', '', 'Nenhum', ev.caso_id);
                    $('#evento-status').value = ev.status || 'Agendado';
                    $('#evento-descricao').value = ev.descricao || '';
                }
            }
            $('#evento-modal-titulo').innerText = id ? 'Editar Evento / Prazo' : 'Novo Evento / Prazo';
            $('#modal-evento').classList.add('active');
        }

        async function salvarEvento(event) {
            event.preventDefault();
            const id = $('#evento-id').value;
            const record = {
                titulo: $('#evento-titulo').value,
                tipo_evento: $('#evento-tipo').value,
                datahora: $('#evento-datahora').value,
                local: $('#evento-local').value,
                cliente_id: $('#evento-cliente').value,
                caso_id: $('#evento-caso').value,
                status: $('#evento-status').value,
                descricao: $('#evento-descricao').value
            };
            if (!record.titulo || !record.datahora) return showNotif('danger', 'T√≠tulo e data/hora s√£o obrigat√≥rios.');
            try {
                if (id) {
                    await gsUpdateRow('agenda', id, record);
                    showNotif('success', 'Evento atualizado!');
                } else {
                    await gsAddRow('agenda', record);
                    showNotif('success', 'Evento salvo!');
                }


                fecharModal('modal-evento');
                renderAgenda();
                loadDashboard();
            } catch (e) {
                showNotif('danger', 'Erro: ' + e.message);
                console.error(e);
            }
        }

        async function abrirModalTarefa(id = null) {
            $('#modal-tarefa form').reset();
            $('#tarefa-id').value = '';
            await populateSelect('tarefa-cliente', 'clientes', 'id', 'nome');
            await populateSelect('tarefa-caso', 'casos', 'id', 'numero');
            if (id) {
                const tarefa = await getRowById('tarefas', id);
                if (tarefa) {
                    $('#tarefa-id').value = tarefa.id;
                    $('#tarefa-descricao').value = tarefa.descricao || '';
                    $('#tarefa-prioridade').value = tarefa.prioridade || 'Baixa';
                    $('#tarefa-prazo').value = tarefa.prazo ? tarefa.prazo.split('T')[0] : '';
                    await populateSelect('tarefa-cliente', 'clientes', 'id', 'nome', '', 'Selecione', tarefa.cliente_id);
                    await populateSelect('tarefa-caso', 'casos', 'id', 'numero', '', 'Nenhum', tarefa.caso_id);
                    $('#tarefa-status').value = tarefa.status || 'Pendente';
                }
                $('#tarefa-modal-titulo').innerText = 'Editar Tarefa';
            } else {
                $('#tarefa-modal-titulo').innerText = 'Nova Tarefa';
                $('#tarefa-status').value = 'Pendente';
            }
            $('#modal-tarefa').classList.add('active');
        }

        async function salvarTarefa(event) {
            event.preventDefault();
            const id = $('#tarefa-id').value;
            const record = {
                descricao: $('#tarefa-descricao').value,
                prioridade: $('#tarefa-prioridade').value,
                prazo: $('#tarefa-prazo').value,
                cliente_id: $('#tarefa-cliente').value,
                caso_id: $('#tarefa-caso').value,
                status: $('#tarefa-status').value || 'Pendente'
            };
            if (!record.descricao) return showNotif('danger', 'A descri√ß√£o √© obrigat√≥ria.');
            try {
                if (id) {
                    await gsUpdateRow('tarefas', id, record);
                    showNotif('success', 'Tarefa atualizada!');
                } else {
                    await gsAddRow('tarefas', record);
                    showNotif('success', 'Tarefa salva!');
                }


                fecharModal('modal-tarefa');
                renderTarefas();
                loadDashboard();
            } catch (e) {
                showNotif('danger', 'Erro: ' + e.message);
                console.error(e);
            }
        }

        async function concluirTarefa(id, isChecked) {
            try {
                await gsUpdateRow('tarefas', id, { status: isChecked ? 'Conclu√≠da' : 'Pendente' });
                renderTarefas();
                loadDashboard();
            } catch (e) {
                console.error('Erro ao concluir tarefa:', e);
                showNotif('danger', 'Erro ao atualizar tarefa.');
            }
        }

        async function abrirModalFin(tipo, id = null) {
            $('#modal-fin form').reset();
            $('#fin-id').value = '';
            $('#fin-tipo').value = tipo;
            await populateSelect('fin-cliente', 'clientes', 'id', 'nome');
            await populateSelect('fin-caso', 'casos', 'id', 'numero');
            if (id) {
                const fin = await getRowById('fin', id);
                if (fin) {
                    $('#fin-id').value = fin.id;
                    $('#fin-tipo').value = fin.tipo;
                    $('#fin-descricao').value = fin.descricao || '';
                    $('#fin-categoria').value = fin.categoria || 'Honor√°rios';
                    $('#fin-valor').value = fin.valor || '';
                    $('#fin-data').value = fin.data ? fin.data.split('T')[0] : '';
                    $('#fin-status').value = fin.status_pg || 'Pendente';
                    await populateSelect('fin-cliente', 'clientes', 'id', 'nome', '', 'Selecione', fin.cliente_id);
                    await populateSelect('fin-caso', 'casos', 'id', 'numero', '', 'Nenhum', fin.caso_id);
                    tipo = fin.tipo;
                }
            }
            $('#fin-titulo').innerText = tipo === 'Receber' ? (id ? 'Editar Receita' : 'Nova Receita') : (id ? 'Editar Despesa' : 'Nova Despesa');
            $('#modal-fin').classList.add('active');
        }

        async function salvarFin(event) {
            event.preventDefault();
            const id = $('#fin-id').value;
            const record = {
                descricao: $('#fin-descricao').value,
                categoria: $('#fin-categoria').value,
                valor: $('#fin-valor').value,
                data: $('#fin-data').value,
                status_pg: $('#fin-status').value,
                cliente_id: $('#fin-cliente').value,
                caso_id: $('#fin-caso').value,
                tipo: $('#fin-tipo').value
            };
            if (!record.descricao || !record.valor || !record.data) return showNotif('danger', 'Preencha todos os campos obrigat√≥rios.');
            try {
                if (id) {
                    await gsUpdateRow('fin', id, record);
                    showNotif('success', 'Lan√ßamento atualizado!');
                } else {
                    await gsAddRow('fin', record);
                    showNotif('success', 'Lan√ßamento salvo!');
                }
                fecharModal('modal-fin');
                loadFinanceiro();
                loadDashboard();
            } catch (e) {
                showNotif('danger', 'Erro: ' + e.message);
                console.error(e);
            }
        }

        function exportarDados(tableName) {
            showNotif('info', 'Gerando CSV, aguarde...');
            google.script.run.withSuccessHandler(res => {
                if (res && res.url) {
                    const a = document.createElement('a');
                    a.href = res.url;
                    a.download = `${tableName}.csv`;
                    a.target = '_blank';
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    showNotif('success', 'Arquivo pronto para download.');
                } else {
                    showNotif('danger', 'Falha ao gerar arquivo.');
                }
            }).withFailureHandler(e => {
                showNotif('danger', 'Erro: ' + e.message);
                console.error(e);
            }).exportSheetCsv(tableName);
        }

        /* ------------- CONTROLE DO SIDEBAR ------------- */
        const hamburgerMenu = document.getElementById('hamburger-menu');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');

        hamburgerMenu.addEventListener('click', () => {
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        });

        overlay.addEventListener('click', () => {
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
        });

        function closeSidebar() {
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
        }

        /* ------------- INICIALIZA√á√ÉO ------------- */
        document.addEventListener('DOMContentLoaded', () => {
            // Event listeners para login, etc.
            $('#btnLogin').addEventListener('click', handleLogin);
            $('#btnLogout').addEventListener('click', handleLogout);
            $('#btnCriarConta').addEventListener('click', () => showNotif('info', 'Funcionalidade de criar conta ainda n√£o implementada.'));

            // Checa a sess√£o do usu√°rio ao carregar
            checkUserSession();

            // Fecha modais ao clicar no fundo
            $$('.modal-bg').forEach(bg => {
                bg.addEventListener('click', (e) => {
                    if (e.target === bg) {
                        fecharModal(bg.id);
                    }
                });
            });
        });

        /* ------------- AUTENTICA√á√ÉO ------------- */
        function checkUserSession() {
            const logged = localStorage.getItem('userLoggedIn') === '1';
            if (logged) {
                $('#login-panel').style.display = 'none';
                $('#app').style.display = 'block';
                abrirTab(0);
            } else {
                $('#login-panel').style.display = 'block';
                $('#app').style.display = 'none';
            }
        }

        async function handleLogin() {
            const email = $('#login-email').value;
            const password = $('#login-senha').value;
            try {
                const { success } = await gsLogin(email, password);
                if (success) {
                    localStorage.setItem('userLoggedIn', '1');
                    $('#login-erro').style.display = 'none';
                    checkUserSession();
                } else {
                    $('#login-erro').innerText = 'E-mail ou senha inv√°lidos.';
                    $('#login-erro').style.display = 'block';
                }
            } catch (e) {
                $('#login-erro').innerText = 'Erro ao autenticar.';
                $('#login-erro').style.display = 'block';
            }
        }

        function handleLogout() {
            localStorage.removeItem('userLoggedIn');
            checkUserSession();
        }

    </script>
</body>

</html>
